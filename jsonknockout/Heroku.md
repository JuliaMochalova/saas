# Heroku

Данный текст содержит инструкции по выкладыванию данного проекта записной книжки в облако [Heroku](http://heroku.com).

В рамках данной лабораторной вы будете работать со следующими технологиями:

- PlayFramework
- Heroku Cloud
- Heroku CLI (Heroku Toolbelt)
- PaaS

# Задание
Необходимо запустить приложние в облаке [Heroku](http://heroku.com)


# Инструкции

Чтобы запустить приложение в облаке Heroku нужно выполнить следующую последовательность действий:

- зарегистрироваться в сервисе [Heroku](http://heroku.com)
- установить Heroku CLI
- создать приложение Heroku
- подключить базу данных PostgreSQL
- загрузить исходные тексты приложения в репозиторий

## Регистрация в сервисе Heroku

Для регистрации в сервисе необходимо заполнить [форму регистрации](https://signup.heroku.com/dc)

## Установка и настройка Heroku CLI
 
Для того чтобы установить Heroku CLI необходимо скачать приложение в соответсвии с Вашей операционной системой на странице [Heroku CLI](https://devcenter.heroku.com/articles/heroku-cli#download-and-install)

Дополнительно можно прописать путь до установленного приложения в переменую окружения PATH для того, чтобы она была доступна из консоли. Кроме того, можно добавить путь с помощью консоли.

В частности для Windows
```terminal
SET PATH=%PATH%;C:\Program Files\Heroku\bin
```

Если доступ в интернет осуществляется через прокси-сервер, то необходимо прописать соответствующие настройки с помощью переменных окружения

```bash
SET HTTP_PROXY=http://proxy.isu.ru
SET HTTPS_PROXY=https://proxy.isu.ru
```
Теперь можно вводить команды Heroku CLI. Введите 

```bash
$ heroku
```
Первый вызов этой команды предложит вам аутентифицироваться с помощью электронной почты и пароля, указанного при регистрации. Не забудьте выполнить команду

```bash
$ heroku logout
```
по завершении сеанса работы с Heroku.

## Создание приложения Heroku
Откройте консоль, перейдите в папку с проектом. Команда

```bash
$ heroku create my-unique-name-of-the-project
```
Если вы не хотите указывать имя, Heroku может сгенерировать уникальное имя за вас. Для этого просто введите

```bash
$ heroku create
```

Созданное приложение будет доступно по соответствующему адресу в домене herokuapp.com, например в примере выше будет развернуто приложение по адресу
http://my-unique-name-of-the-project.herokuapp.com

Для того, чтобы открыть запущенное приложение в браузере, введите команду 

```bash
$ heroku open
```

Данное приложение будет содержать статическую страницу. При этом будет создан GIT-репозиторий, в который можно загружать свое приложение.
Необходимо добавить исходные тексты программы.

Поскольку вся установка и запуск приложения происходит удаленно, нам потребуется несколько команд для мониторинга состояния.
Чтобы посмотреть текущее состояние приложения в облаке введите команду

```bash
$ heroku ps
```
Состояние может быть starting, up, restarting или crashed. В случае, если приложение упало с ошибкой (сrashed) мы можем производить диагностику с помощью журнала.

Чтобы посмотреть журнал введите команду

```bash
$ heroku logs
```

## Подключение базы данных PostgreSQL

Поскольку мы отлаживаем приложение локально в H2, которая запущена в памяти компьютера, на сервере в PROD[UCTION] режиме такой сценарий не работает.
Необходимо использовать внешнюю СУБД. В частности, в Heroku автоматически выделяется PostgreSQL.

Для того чтобы подключить базу данных PostgreSQL необходимо отредактировать файл `build.sbt` и добавить в него строку

```scala

libraryDependencies += "postgresql" % "postgresql" % "9.1-901-1.jdbc4"

```
Это даст инструкцию скачать драйвер PostgreSQL, реализующий JDBC API  и подключить его к проекту.

Затем необходимо перекрыть настройки подключения к СУБД, создав специальный файл с именем `Procfile`. 
Его имя должно начинаться с большой буквы и не иметь расширения. Введите в него следующую строку:

```
web: target/universal/stage/bin/jsonknockout  -Dhttp.port=$PORT -DapplyEvolutions.default=true -Ddb.default.driver=org.postgresql.Driver -Ddb.default.url=$DATABASE_URL
```

Где `jsonknockout` - имя приложения, `-Dhttp.port` и -Ddb.default.url=$DATABASE_URL задают настройки подключения к СУБД с помощью драйвера `-Ddb.default.driver`; 
`-DapplyEvolutions.default` задает инструкцию по автоматическому применению эволюций (скриптов SQL) по автоматической генерации и обновлении базы данных.

## Загрузка приложения
После выполнения команды
```bash
$ heroku create
```
В git репозиторий проекта был добавлен удаленный репозиторий с именем heroku. Можно увидеть это, введя

```bash
$ git remote
```

Для того чтобы наш локальный репозиторий проекта развернулся на сервере введите команду

```bash
$ git push heroku master
```

Автоматически произойдет загрузка исходных текстов и конфигурации на сервер. После чего начнется разрешение зависимостей, сборка и запуск проекта.

В случае, если все прошло успешно, введите команду
```bash
$ heroku open
```
для открытия в браузере.

В случае ошибки, воспользуйтесь командой
```bash
$ heroku logs
```
для просмотра журнала.


